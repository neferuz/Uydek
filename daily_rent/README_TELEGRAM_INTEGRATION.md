# Telegram WebApp Integration –¥–ª—è Daily Rent

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Telegram WebApp –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

## –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. TelegramProvider (Frontend)
- **–§–∞–π–ª**: `frontend-next/src/app/components/TelegramProvider.tsx`
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
  - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–æ—Ç
- **–§–∞–π–ª**: `daily_rent/bot.py`
- **–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
  - –ö–æ–º–∞–Ω–¥–∞ `/help`
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TelegramProvider
- **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**: `telegram-user.html` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 4. –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è ngrok
- **get_ngrok_url.py**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ ngrok URL
- **update_webapp_url.py**: –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok
```bash
# –°–∫–∞—á–∞–π—Ç–µ ngrok —Å https://ngrok.com/
# –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ npm
npm install -g ngrok

# –ò–ª–∏ —á–µ—Ä–µ–∑ Homebrew (macOS)
brew install ngrok
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ngrok
```bash
# –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ ngrok (–ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∞ https://dashboard.ngrok.com/)
ngrok config add-authtoken YOUR_NGROK_TOKEN

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (Next.js –Ω–∞ –ø–æ—Ä—Ç—É 3000)
ngrok http 3000

# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ (FastAPI –Ω–∞ –ø–æ—Ä—Ç—É 8000)
ngrok http 8000
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
# –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ ngrok, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
cd daily_rent
python get_ngrok_url.py
```

### 4. –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
```bash
# –ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
cd daily_rent
python update_webapp_url.py
```

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ ngrok –ø–æ–ª—É—á–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–µ URL –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª—ã:

**daily_rent/.env:**
```env
BOT_TOKEN=8065953292:AAGzNG5IKBDRIUXMtsr1XHPXZl4FUHZ0L9A
DATABASE_URL="postgresql://imells:1235804679farangizF.@localhost:5432/daily_rent_db"
WEBAPP_URL=https://your-ngrok-url.ngrok-free.app
```

**frontend-next/.env.local:**
```env
NEXT_PUBLIC_BACKEND_URL=https://your-backend-ngrok-url.ngrok-free.app
```

### 6. –ë—ç–∫–µ–Ω–¥
```bash
cd daily_rent
pip install -r requirements.txt
python bot.py
```

### 7. Frontend
```bash
cd frontend-next
npm install
npm run dev
```

### 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/start`
4. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üè† –û—Ç–∫—Ä—ã—Ç—å Daily Rent"

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok
ngrok http 3000

# 2. –í –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
cd daily_rent
python get_ngrok_url.py

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
python bot.py

# 4. –í –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
cd frontend-next
npm run dev
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ ngrok

### –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω ngrok
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: 1 —Ç—É–Ω–Ω–µ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, 40 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π/–º–∏–Ω—É—Ç—É
- **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –∞ –±—ç–∫–µ–Ω–¥ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –Ω–∞ VPS

### –ü–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω ngrok
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–∏, —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ URL
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã ngrok
- **Cloudflare Tunnel** - –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **LocalTunnel** - –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –º–µ–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ
- **VPS —Å –¥–æ–º–µ–Ω–æ–º** - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### Telegram User Object
```typescript
interface TelegramUser {
  id: number;
  first_name: string;
  last_name?: string;
  username?: string;
  photo_url?: string;
  language_code?: string;
  is_premium?: boolean;
}
```

### –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –≤ –±–æ—Ç –¥–∞–Ω–Ω—ã–µ
```javascript
{
  action: 'user_verified' | 'profile_loaded' | 'apartments_loaded' | 'search_performed' | 'apartment_viewed',
  user_id: number,
  timestamp: string,
  // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç action
}
```

## API Endpoints

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
```
POST /users/me/telegram-id
Content-Type: application/json

{
  "telegram_id": 123456789,
  "first_name": "–ò–≤–∞–Ω",
  "last_name": "–ò–≤–∞–Ω–æ–≤",
  "username": "ivan_ivanov",
  "photo_url": "https://t.me/i/userpic/320/photo.jpg"
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram Init Data
```
GET /users/me/telegram
Headers: {
  "X-Telegram-Init-Data": "query_id=...&user=...&auth_date=...&hash=..."
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è Init Data
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HMAC-SHA256 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è timestamp (–Ω–µ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è hash –æ—Ç Telegram

### –§–∞–π–ª –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `daily_rent/app/utils/telegram_auth.py`

## –û—Ç–ª–∞–¥–∫–∞

### Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
–í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (localhost) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
- Init Data
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–µ—Ä—Å–∏—è WebApp
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–º—ã

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ë–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è—Ö
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ ngrok —Ç—É–Ω–Ω–µ–ª–µ–π
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª–µ–π
ngrok status

# –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏
ngrok http 3000 --log=stdout

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ngrok API
curl http://127.0.0.1:4040/api/tunnels
```

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Telegram WebApp Documentation](https://core.telegram.org/bots/webapps)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Telegram WebApp SDK](https://telegram.org/js/telegram-web-app.js)
- [ngrok Documentation](https://ngrok.com/docs)
- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram WebApp, –∞ –Ω–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –±–æ—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_webapp_data)`

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Init Data
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å BOT_TOKEN –∏ –∞–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ `telegram_auth.py`

### –ü—Ä–æ–±–ª–µ–º–∞: ngrok —Ç—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ**: 
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ngrok –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: `ngrok config check`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç –Ω–µ –∑–∞–Ω—è—Ç: `lsof -i :3000`
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç: `ngrok http 3001`

### –ü—Ä–æ–±–ª–µ–º–∞: CORS –æ—à–∏–±–∫–∏
**–†–µ—à–µ–Ω–∏–µ**: 
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ngrok URL
2. –î–æ–±–∞–≤—å—Ç–µ ngrok URL –≤ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FastAPI
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π BACKEND_URL

### –ü—Ä–æ–±–ª–µ–º–∞: –°–∫—Ä–∏–ø—Ç get_ngrok_url.py –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ**:
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ngrok –∑–∞–ø—É—â–µ–Ω: `ngrok http 3000`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ngrok API –¥–æ—Å—Ç—É–ø–µ–Ω: `curl http://127.0.0.1:4040/api/tunnels`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `python update_webapp_url.py` 